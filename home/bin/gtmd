#!/bin/bash

# Function to convert HTML to Markdown
convert_html_to_markdown() {
  local input="$1"
  
  # Remove blockquote tags
  input="${input//<blockquote>/}"
  input="${input//<\/blockquote>/}"
  
  # Convert <br /> and <br> to newlines
  input="${input//<br \/>/$'\n'}"
  input="${input//<br>/$'\n'}"
  
  # Convert HTML entities
  input="${input//&amp;/&}"
  input="${input//&lt;/<}"
  input="${input//&gt;/>}"
  input="${input//&quot;/\"}"
  input="${input//&#39;/\'}"
  
  # Convert emojis to shortcodes
  input="${input//ğŸ‘€/:eyes:}"
  input="${input//ğŸš€/:rocket:}"
  input="${input//âœ…/:white_check_mark:}"
  input="${input//ğŸ”„/:arrows_counterclockwise:}"
  input="${input//â¸ï¸/:pause_button:}"
  input="${input//âŒ/:x:}"
  input="${input//ğŸ”€/:twisted_rightwards_arrows:}"
  input="${input//ğŸ“/:memo:}"
  input="${input//ğŸ¯/:dart:}"
  input="${input//âš¡/:zap:}"
  
  # Convert <a href="url">text</a> to [text](url)
  input=$(echo "$input" | sed -E 's|<a href="([^"]+)">([^<]+)</a>|[\2](\1)|g')
  
  # Convert <code>text</code> to `text`
  input=$(echo "$input" | sed -E 's|<code>([^<]+)</code>|`\1`|g')
  
  # Add markdown quote prefix to each line
  local output=""
  while IFS= read -r line; do
    if [[ -n "$line" ]]; then
      output+=$(echo "> $line" | sed 's/^> *$/>/g')$'\n'
    fi
  done <<< "$input"
  
  # Remove trailing newline
  echo -n "${output%$'\n'}"
}

# Main script
main() {
  local input_text=""
  
  if [[ $# -gt 0 ]]; then
    input_text="$*"
  elif [[ ! -t 0 ]]; then
    input_text=$(cat)
  else
    local tmpfile=$(mktemp)
    trap "rm -f '$tmpfile'" EXIT
    
    cat > "$tmpfile" << 'EOF'

# Paste the raw HTML output from Graphite share above this comment.
# Lines starting with # will be ignored.
# Save and close the editor when done.
EOF
    
    ${EDITOR:-vim} +1 "$tmpfile"
    
    input_text=$(grep -v '^#' "$tmpfile" | sed '/^$/d')
  fi
  
  if [[ -z "$input_text" ]]; then
    echo "Error: No input provided"
    exit 1
  fi
  
  # Convert to markdown
  markdown=$(convert_html_to_markdown "$input_text")
  
  # Print output
  echo ""
  echo "------------------------------------------------"
  echo ""
  echo "$markdown"
  echo ""
  echo "------------------------------------------------"
  
  # Copy to clipboard using pbcopy
  echo -n "$markdown" | pbcopy
  echo ""
  echo "Copied to clipboard!"
}

main "$@"